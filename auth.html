<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AKUN WIBU - TongDev | Stream</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bangers:wght@400;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <script src="https://cdn.tailwindcss.com"></script>

  <style type="text/tailwindcss">
    @layer base {
      body {
        background-color: #FFF9E0;
        font-family: 'Inter', sans-serif;
        color: #222222;
        overflow-x: hidden;
        padding-bottom: 80px;
      }
    }
    @layer components {
      .comic-title-stroke {
        font-family: 'Bangers', cursive;
        letter-spacing: 1px;
        color: #FFD75C !important;
        text-shadow:
          2px 2px 0 #000,
          -2px -2px 0 #000,
          2px -2px 0 #000,
          -2px 2px 0 #000,
          2px 0 0 #000,
          -2px 0 0 #000,
          0 2px 0 #000,
          0 -2px 0 #000,
          1px 1px 2px rgba(0, 0, 0, 0.6);
      }
      .comic-border {
        border: 4px solid #000000;
      }
      .comic-shadow {
        box-shadow: 6px 6px 0px #000000;
      }
      .bottom-nav-item {
        @apply flex flex-col items-center justify-center p-2 text-textblack tap-highlight-transparent transition-transform duration-200 ease-out;
      }
      .bottom-nav-item .nav-icon {
        @apply text-2xl;
      }
      .bottom-nav-item .nav-text {
        @apply font-bangers text-lg tracking-wide;
      }
      .bottom-nav-item.active {
        @apply text-mustard;
        -webkit-text-stroke: 1px #000;
        text-shadow: 1px 1px 0 #000;
      }
      .comic-button {
        @apply bg-mustard font-bangers text-2xl px-6 py-2 comic-border rounded-md comic-shadow text-textblack comic-title-stroke tracking-wider transition-all duration-200 hover:scale-105 active:scale-95 active:shadow-none active:translate-x-1 active:translate-y-1;
      }
      .comic-button-secondary {
        @apply bg-gray-200 font-bangers text-2xl px-6 py-2 comic-border rounded-md comic-shadow text-textblack tracking-wider transition-all duration-200 hover:bg-gray-300 active:scale-95 active:shadow-none active:translate-x-1 active:translate-y-1;
      }
      .comic-input {
        @apply w-full p-3 font-inter text-lg text-textblack bg-white comic-border rounded-md focus:outline-none focus:ring-4 focus:ring-mustard;
      }
      .profile-tab-btn {
        @apply flex-1 py-3 px-2 font-bangers text-2xl tracking-wider text-gray-600 border-b-4 border-transparent text-center transition-colors duration-200;
      }
      .profile-tab-btn.active {
        @apply text-mustard comic-title-stroke border-b-black;
      }
      .profile-tab-panel {
        @apply hidden;
      }
      .profile-tab-panel.active {
        @apply block;
      }
    }
    @layer utilities {
      .tap-highlight-transparent {
        -webkit-tap-highlight-color: transparent;
      }
    }
  </style>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            mustard: '#FFC300',
            panel: '#FFF9E0',
            textblack: '#222222',
          },
          fontFamily: {
            bangers: ['Bangers', 'cursive'],
            inter: ['Inter', 'sans-serif'],
          }
        }
      }
    }
  </script>
</head>
<body class="bg-panel text-textblack font-inter">

  <div id="error-state" class="fixed inset-0 bg-black/50 z-40 flex justify-center items-center p-4 hidden backdrop-blur-sm">
    <div class="bg-panel comic-border rounded-md p-8 sm:p-12 text-center text-textblack comic-shadow max-w-lg w-full" onclick="event.stopPropagation()">
      <div class="text-7xl sm:text-9xl">ðŸš«</div>
      <div id="error-title" class="comic-title-stroke text-5xl sm:text-7xl text-mustard mt-4">
        Oops! Gagal!
      </div>
      <div id="error-message" class="font-inter text-xl sm:text-2xl mt-6">
        Terjadi kesalahan. Coba lagi nanti.
      </div>
      <p class="font-inter text-sm mt-4">(Klik di mana saja untuk menutup)</p>
      <button id="retry-button" class="hidden mt-10 bg-mustard font-bangers text-3xl px-10 py-3 comic-border rounded-md comic-shadow text-textblack comic-title-stroke tracking-wider transition-transform duration-200 hover:scale-105 active:scale-95">
        Coba Lagi
      </button>
    </div>
  </div>

  <div id="main-content" class="">

    <main id="auth-page-content" class="p-4 max-w-4xl mx-auto pt-8">

      <div id="login-view" class="">
        <div class="bg-white p-6 md:p-8 rounded-lg comic-border comic-shadow">
          <h1 class="comic-title-stroke text-5xl text-mustard text-center">Login Dulu, Wibu!</h1>
          <p class="font-inter text-lg text-center mt-2 mb-6 text-gray-700">Untuk menyimpan favorit, melanjutkan tontonan, dan lainnya!</p>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <button id="google-login-btn" class="w-full p-3 bg-white text-gray-700 font-semibold text-lg rounded-md border border-gray-300 shadow-sm flex items-center justify-center gap-3 transition-colors duration-200 hover:bg-gray-100">
              <svg class="w-5 h-5" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                <path fill="#FFC107" d="M43.611 20.083H42V20H24v8h13.303c-1.628 5.09-6.49 8.82-12.303 8.82-7.34 0-13.32-5.98-13.32-13.32s5.98-13.32 13.32-13.32c3.54 0 6.78 1.4 9.1 3.69l5.65-5.65C34.54 5.16 29.6 3 24 3 10.74 3 0 13.74 0 27s10.74 24 24 24 24-10.74 24-24c0-1.58-.16-3.12-.4-4.64z"></path>
                <path fill="#FF3D00" d="M6.306 14.691c-1.32 2.19-2.09 4.74-2.09 7.309s.77 5.12 2.09 7.309l-5.65 5.65C.85 31.09 0 29.12 0 27s.85-4.09 2.3-5.65l3.65-3.65z"></path>
                <path fill="#4CAF50" d="M24 48c6.62 0 12.23-2.3 16.29-6.3l-5.65-5.65c-2.32 1.57-5.32 2.45-8.64 2.45-6.7 0-12.4-4.52-14.45-10.61l-5.9 5.9C5.16 43.1 13.8 48 24 48z"></path>
                <path fill="#1976D2" d="M43.611 20.083H24v8h13.303c-.4 2.72-1.6 5.12-3.3 7.02l5.65 5.65c3.54-3.26 5.75-8.1 5.75-13.67 0-1.58-.16-3.12-.4-4.64z"></path>
              </svg>
              Login dengan Google
            </button>
            <button id="github-login-btn" class="comic-button !bg-gray-800 !text-white !normal-case !font-inter !font-bold !text-lg !comic-title-stroke-none !shadow-md flex items-center justify-center gap-2">
              <i class="fa-brands fa-github"></i> GitHub
            </button>
          </div>

          <div class="text-center my-4 font-inter font-bold text-gray-600">ATAU DENGAN EMAIL</div>

          <div class="space-y-4">
            <input type="email" id="email-input" placeholder="Email kamu" class="comic-input">
            <input type="password" id="password-input" placeholder="Password rahasia" class="comic-input">
            <div class="flex gap-4">
              <button id="email-login-btn" class="comic-button w-full">Login</button>
              <button id="register-btn" class="comic-button-secondary w-full">Daftar</button>
            </div>
          </div>
        </div>
      </div>

      <div id="profile-view" class="hidden">

        <div class="bg-white p-6 rounded-lg comic-border comic-shadow text-center relative">
          <img id="profile-img" src="https://placehold.co/200x200/FFF9E0/000?text=?" alt="Foto Profil" class="w-32 h-32 rounded-full mx-auto comic-border border-4 object-cover -mt-20 mb-4 bg-panel">
          <h2 id="profile-username" class="font-bangers text-4xl tracking-wide text-textblack">Memuat...</h2>
          <p id="profile-email" class="font-inter text-gray-700 mb-6">memuat@email.com</p>

          <div class="flex gap-4 justify-center">
            <button id="edit-profile-btn" class="comic-button-secondary !text-xl">
              <i class="fa-solid fa-pencil mr-1"></i> Ubah Profil
            </button>
            <button id="logout-btn" class="comic-button !text-xl !bg-red-500 !text-white !comic-title-stroke-none">
              <i class="fa-solid fa-right-from-bracket mr-1"></i> Logout
            </button>
          </div>
        </div>
        
        <div class="bg-white p-6 rounded-lg comic-border comic-shadow mt-6">
          <h3 class="font-bangers text-2xl tracking-wide text-textblack mb-2">Level & XP</h3>
          <div id="level-text" class="font-inter font-bold text-lg text-gray-700 mb-3">Level 0 - 0%</div>
          <div class="w-full bg-gray-300 rounded-full h-6 comic-border border-2 overflow-hidden">
            <div id="xp-bar-inner" class="bg-mustard h-full rounded-full transition-all duration-500" style="width: 0%"></div>
          </div>
        </div>

        <div class="mt-8">
          <h3 class="comic-title-stroke text-4xl text-mustard mb-4">Lanjutkan Tonton</h3>
          <div id="progress-grid-container" class="flex overflow-x-auto space-x-4 p-2 snap-x snap-mandatory scroll-smooth min-h-[10rem]">
            <div class="w-full flex-shrink-0 flex items-center justify-center">
              <p class="text-center font-inter text-gray-600">Memuat progress tontonan...</p>
            </div>
          </div>
        </div>

        <div class="mt-8">
          <div id="profile-tabs" class="flex border-b-4 border-black mb-4">
            <button class="profile-tab-btn active" data-tab="finished">Ditamatkan</button>
            <button class="profile-tab-btn" data-tab="favorites">Favorit</button>
            <button class="profile-tab-btn" data-tab="saved">Disimpan</button>
          </div>
          
          <div id="profile-tab-panels">
            <div id="tab-panel-finished" class="profile-tab-panel active">
              <div id="finished-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 min-h-[10rem]">
                <p class="col-span-full text-center font-inter text-gray-600 py-16">Memuat anime ditamatkan...</p>
              </div>
            </div>
            <div id="tab-panel-favorites" class="profile-tab-panel">
              <div id="favorites-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 min-h-[10rem]">
                <p class="col-span-full text-center font-inter text-gray-600 py-16">Memuat favorit...</p>
              </div>
            </div>
            <div id="tab-panel-saved" class="profile-tab-panel">
              <div id="saved-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 min-h-[10rem]">
                <p class="col-span-full text-center font-inter text-gray-600 py-16">Memuat anime disimpan...</p>
              </div>
            </div>
          </div>
        </div>

        <div class="bg-white p-6 rounded-lg comic-border comic-shadow text-center mt-6 hidden">
          <div class="flex justify-around items-center">
            <div class="px-2">
              <span id="stat-finished" class="block font-bangers text-5xl text-mustard comic-title-stroke">0</span>
              <span class="block font-inter font-bold text-sm">Ditamatkan</span>
            </div>
            <div class="border-l-4 border-r-4 border-black px-6">
              <span id="stat-favorites" class="block font-bangers text-5xl text-mustard comic-title-stroke">0</span>
              <span class="block font-inter font-bold text-sm">Favorit</span>
            </div>
            <div class="px-2">
              <span id="stat-saved" class="block font-bangers text-5xl text-mustard comic-title-stroke">0</span>
              <span class="block font-inter font-bold text-sm">Disimpan</span>
            </div>
          </div>
        </div>

      </div>
    </main>

  </div>

  <div id="edit-profile-modal" class="fixed inset-0 bg-black/50 z-40 flex justify-center items-center p-4 hidden backdrop-blur-sm">
    <div class="bg-panel comic-border rounded-md p-6 sm:p-8 text-textblack comic-shadow max-w-lg w-full" onclick="event.stopPropagation()">
      <h2 class="comic-title-stroke text-4xl text-mustard mb-6">Ubah Profil</h2>
      <div class="space-y-4">
        <div>
          <label for="modal-username" class="font-inter font-bold mb-1 block">Username</label>
          <input type="text" id="modal-username" placeholder="Username baru kamu" class="comic-input">
        </div>
        <div>
          <label for="modal-photo-url" class="font-inter font-bold mb-1 block">URL Foto Profil</label>
          <input type="text" id="modal-photo-url" placeholder="https://example.com/gambar.jpg" class="comic-input">
          <a href="https://catbox.moe" target="_blank" class="text-sm text-blue-600 hover:underline mt-1 block">Klik di sini untuk upload gambar</a>
        </div>
        <div class="flex gap-4 pt-4">
          <button id="save-profile-btn" class="comic-button w-full">Simpan</button>
          <button id="cancel-edit-btn" class="comic-button-secondary w-full">Batal</button>
        </div>
      </div>
    </div>
  </div>

  <nav id="bottom-navigation" class="fixed bottom-0 left-0 right-0 bg-mustard border-t-8 comic-border p-1 z-30 flex justify-around items-center comic-shadow" style="box-shadow: 0px -6px 0px #000000;">
    <a href="index.html" class="bottom-nav-item" >
      <i class="fa-solid fa-house nav-icon"></i>
      <span class="nav-text">Home</span>
    </a>
    <a href="latest.html" class="bottom-nav-item">
      <i class="fa-solid fa-clock nav-icon"></i>
      <span class="nav-text">Terbaru</span>
    </a>
    <a href="search.html" class="bottom-nav-item">
      <i class="fa-solid fa-search nav-icon"></i>
      <span class="nav-text">Search</span>
    </a>
    <a href="populer.html" class="bottom-nav-item">
      <i class="fa-solid fa-star nav-icon"></i>
      <span class="nav-text">Populer</span>
    </a>
    <a href="auth.html" class="bottom-nav-item active" aria-current="page">
      <i class="fa-solid fa-user nav-icon"></i>
      <span class="nav-text">Profil</span>
    </a>
  </nav>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import {
        getAuth, onAuthStateChanged, GoogleAuthProvider,
        GithubAuthProvider, signInWithPopup, createUserWithEmailAndPassword,
        signInWithEmailAndPassword, signOut, updateProfile
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
    import { getDatabase, ref, get, set, update, onValue, off, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDDwVSn_7EYluIaFjyqZcg2aFjpEiNbEiw",
        authDomain: "web-anime-f8aab.firebaseapp.com",
        databaseURL: "https://web-anime-f8aab-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "web-anime-f8aab",
        storageBucket: "web-anime-f8aab.appspot.com",
        messagingSenderId: "745149903589",
        appId: "1:745149903589:web:212faa7ba522644ccf1a0c",
        measurementId: "G-B81VMWHBN9"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const loginView = document.getElementById('login-view');
    const profileView = document.getElementById('profile-view');
    const editProfileModal = document.getElementById('edit-profile-modal');
    const errorState = document.getElementById('error-state');
    const errorTitle = document.getElementById('error-title');
    const errorMessage = document.getElementById('error-message');

    const emailInput = document.getElementById('email-input');
    const passwordInput = document.getElementById('password-input');

    const profileImg = document.getElementById('profile-img');
    const profileUsername = document.getElementById('profile-username');
    const profileEmail = document.getElementById('profile-email');

    const statFinished = document.getElementById('stat-finished');
    const statFavorites = document.getElementById('stat-favorites');
    const statSaved = document.getElementById('stat-saved');

    const favoritesGrid = document.getElementById('favorites-grid');
    const savedGrid = document.getElementById('saved-grid');
    const finishedGrid = document.getElementById('finished-grid');
    
    const levelText = document.getElementById('level-text');
    const xpBarInner = document.getElementById('xp-bar-inner');
    const progressGridContainer = document.getElementById('progress-grid-container');
    const tabsContainer = document.getElementById('profile-tabs');
    const tabPanelsContainer = document.getElementById('profile-tab-panels');

    const modalUsernameInput = document.getElementById('modal-username');
    const modalPhotoUrlInput = document.getElementById('modal-photo-url');

    let favoritesRef, savedRef, finishedRef, progressRef, userLevelRef;

    const safeCount = (obj) => {
        return obj ? Object.keys(obj).length : 0;
    };

    const handleAuthError = (error) => {
        let userMessage = "Terjadi kesalahan yang tidak diketahui. Coba lagi.";
        let title = "Autentikasi Gagal!";

        switch (error.code) {
            case 'auth/invalid-email':
                userMessage = "Format email tidak valid. Periksa kembali.";
                break;
            case 'auth/user-not-found':
            case 'auth/wrong-password':
                userMessage = "Email atau password salah. Periksa kembali.";
                break;
            case 'auth/email-already-in-use':
                userMessage = "Email sudah terdaftar. Silakan login.";
                break;
            case 'auth/weak-password':
                userMessage = "Password harus memiliki minimal 6 karakter.";
                break;
            case 'auth/popup-closed-by-user':
                userMessage = "Jendela popup ditutup sebelum login selesai.";
                break;
            case 'PERMISSION_DENIED':
                title = "Error Database!";
                userMessage = "Akses database ditolak. Pastikan Rules Firebase Anda sudah benar (auth != null).";
                break;
            default:
                userMessage = `Terjadi kesalahan. Kode: ${error.code}.`;
        }

        errorTitle.textContent = title;
        errorMessage.textContent = userMessage;
        errorState.classList.remove('hidden');
    };

    errorState.addEventListener('click', function(e) {
        if (e.target === errorState || e.target.closest('#retry-button')) {
            errorState.classList.add('hidden');
        }
    });

    const renderAnimeGrid = (container, data) => {
        if (!container) return;
        container.innerHTML = '';

        if (!data || Object.keys(data).length === 0) {
            container.innerHTML = '<p class="col-span-full text-center font-inter text-gray-600 py-16">Belum ada anime di sini, wibu!</p>';
            return;
        }

        const animeArray = Object.keys(data).map(key => ({
            animeId: key,
            ...data[key]
        }));

        const sortedArray = animeArray.sort((a, b) => {
            const timeA = new Date(a.addedAt || a.lastWatched || a.finishedAt || 0).getTime();
            const timeB = new Date(b.addedAt || b.lastWatched || b.finishedAt || 0).getTime();
            return timeB - timeA;
        });

        sortedArray.forEach(anime => {
            const detailUrl = anime.detailUrl ? `detail.html?url=${encodeURIComponent(anime.detailUrl)}` : '#';
            const card = `
                <div class="bg-white rounded-lg overflow-hidden shadow-md hover:shadow-xl transition-all duration-300 hover:scale-[1.03]">
                    <a href="${detailUrl}" class="block">
                        <img src="${anime.image || 'https://placehold.co/400x600/FFF9E0/000?text=IMG'}" alt="${anime.title || 'Anime Title'}"
                             class="w-full aspect-[3/4] object-cover"
                             onerror="this.onerror=null;this.src='https://placehold.co/400x600/FFF9E0/000?text=IMG';">
                        <div class="p-3 text-center">
                            <h4 class="text-sm font-semibold text-gray-800 truncate">${anime.title || 'Judul Anime'}</h4>
                        </div>
                    </a>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', card);
        });
    };
    
    const renderLevel = (level = 0, xpPercent = 0) => {
        if (levelText && xpBarInner) {
            levelText.textContent = `Level ${level} - ${xpPercent}%`;
            xpBarInner.style.width = `${xpPercent}%`;
        }
    };
    
    const renderProgressGrid = (progressData) => {
        if (!progressGridContainer) return;
        progressGridContainer.innerHTML = '';
        
        if (!progressData) {
            progressGridContainer.innerHTML = '<div class="w-full flex-shrink-0 flex items-center justify-center h-40"><p class="text-center font-inter text-gray-600">Belum ada anime yang sedang ditonton.</p></div>';
            return;
        }
        
        let allProgress = [];
        Object.keys(progressData).forEach(animeId => {
            const episodes = progressData[animeId];
            Object.keys(episodes).forEach(episodeId => {
                allProgress.push(episodes[episodeId]);
            });
        });
        
        if (allProgress.length === 0) {
             progressGridContainer.innerHTML = '<div class="w-full flex-shrink-0 flex items-center justify-center h-40"><p class="text-center font-inter text-gray-600">Belum ada anime yang sedang ditonton.</p></div>';
            return;
        }

        allProgress.sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime());
        
        const latestProgress = allProgress.slice(0, 10);
        
        latestProgress.forEach(item => {
            const episodeUrl = `episod.html?url=${encodeURIComponent(item.episodeUrl)}`;
            const card = `
                <div class="flex flex-col bg-white rounded-lg shadow-md hover:shadow-xl transition-all duration-300 hover:scale-[1.03] w-56 sm:w-64 flex-shrink-0 snap-start overflow-hidden">
                    <a href="${episodeUrl}" class="block">
                        <img src="${item.image || 'https://placehold.co/400x600/FFF9E0/000?text=IMG'}" alt="${item.animeTitle || 'Anime Title'}"
                             class="w-full aspect-video object-cover"
                             onerror="this.onerror=null;this.src='https://placehold.co/400x600/FFF9E0/000?text=IMG';">
                        <div class="p-3 overflow-hidden">
                            <h4 class="text-sm font-semibold text-gray-800 truncate">${item.animeTitle || 'Judul Anime'}</h4>
                            <p class="text-xs text-gray-500 truncate">${item.episodeTitle || 'Episode'}</p>
                        </div>
                    </a>
                </div>
            `;
            progressGridContainer.insertAdjacentHTML('beforeend', card);
        });
    };

    const renderProfileUI = (userData, user) => {
        const username = userData.username || userData.displayName || user.displayName || 'Wibu Baru';
        const photoUrl = userData.photoURL || user.photoURL || 'https://placehold.co/200x200/FFF9E0/000?text=?';

        profileImg.src = photoUrl;
        profileUsername.textContent = username;
        profileEmail.textContent = user.email || 'Email Tidak Disediakan';

        modalUsernameInput.value = username;
        modalPhotoUrlInput.value = photoUrl;
    };

    const attachDataListeners = (uid) => {
        favoritesRef = ref(db, `users/${uid}/favorites`);
        savedRef = ref(db, `users/${uid}/saved`);
        finishedRef = ref(db, `users/${uid}/finished`);
        progressRef = ref(db, `users/${uid}/progress`);
        userLevelRef = ref(db, `users/${uid}`);

        onValue(favoritesRef, (snapshot) => {
            const data = snapshot.val();
            statFavorites.textContent = safeCount(data);
            renderAnimeGrid(favoritesGrid, data);
        });

        onValue(savedRef, (snapshot) => {
            const data = snapshot.val();
            statSaved.textContent = safeCount(data);
            renderAnimeGrid(savedGrid, data);
        });

        onValue(finishedRef, (snapshot) => {
            const data = snapshot.val();
            statFinished.textContent = safeCount(data);
            renderAnimeGrid(finishedGrid, data);
        });
        
        onValue(progressRef, (snapshot) => {
            const data = snapshot.val();
            renderProgressGrid(data);
        });
        
        onValue(userLevelRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                renderLevel(data.level, data.xpPercent);
            } else {
                renderLevel(0, 0);
            }
        });
    };

    const detachDataListeners = () => {
        if (favoritesRef) off(favoritesRef);
        if (savedRef) off(savedRef);
        if (finishedRef) off(finishedRef);
        if (progressRef) off(progressRef);
        if (userLevelRef) off(userLevelRef);

        favoritesRef = null;
        savedRef = null;
        finishedRef = null;
        progressRef = null;
        userLevelRef = null;
    };

    const handleAuthState = async (user) => {
        if (user) {
            const userRef = ref(db, `users/${user.uid}`);

            try {
                const snapshot = await get(userRef);
                let currentUserData;
                const currentTime = new Date().toISOString();

                if (snapshot.exists()) {
                    currentUserData = snapshot.val();
                    await update(ref(db, `users/${user.uid}`), {
                        lastLogin: currentTime
                    });

                } else {
                    const defaultUsername = user.displayName || (user.email ? user.email.split('@')[0] : 'WibuBaru');

                    currentUserData = {
                        email: user.email,
                        displayName: user.displayName || defaultUsername,
                        username: defaultUsername,
                        photoURL: user.photoURL || 'https://placehold.co/200x200/FFF9E0/000?text=?',
                        createdAt: currentTime,
                        lastLogin: currentTime,
                        favorites: {},
                        saved: {},
                        finished: {},
                        level: 0,
                        xpPercent: 0,
                        totalWatchMinutes: 0,
                        progress: {}
                    };

                    await set(userRef, currentUserData);
                }

                renderProfileUI(currentUserData, user);
                profileView.classList.remove('hidden');
                loginView.classList.add('hidden');

                attachDataListeners(user.uid);

            } catch (error) {
                handleAuthError(error);
                profileView.classList.add('hidden');
                loginView.classList.remove('hidden');
            }

        } else {
            detachDataListeners();
            profileView.classList.add('hidden');
            loginView.classList.remove('hidden');
            emailInput.value = '';
            passwordInput.value = '';
        }
    };

    onAuthStateChanged(auth, handleAuthState);

    const googleLogin = async () => {
        try {
            const provider = new GoogleAuthProvider();
            await signInWithPopup(auth, provider);
        } catch (error) {
            handleAuthError(error);
        }
    };

    const githubLogin = async () => {
        try {
            const provider = new GithubAuthProvider();
            await signInWithPopup(auth, provider);
        } catch (error) {
            handleAuthError(error);
        }
    };

    const registerEmail = async () => {
        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();

        if (!email || !password) {
            handleAuthError({ code: 'client/empty-fields', message: 'Email dan Password harus diisi.' });
            return;
        }

        try {
            await createUserWithEmailAndPassword(auth, email, password);
        } catch (error) {
            handleAuthError(error);
        }
    };

    const loginEmail = async () => {
        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();

        if (!email || !password) {
            handleAuthError({ code: 'client/empty-fields', message: 'Email dan Password harus diisi.' });
            return;
        }

        try {
            await signInWithEmailAndPassword(auth, email, password);
        } catch (error) {
            handleAuthError(error);
        }
    };

    const logout = async () => {
        try {
            await signOut(auth);
        } catch (error) {
            handleAuthError(error);
        }
    };

    const openEditModal = () => {
        editProfileModal.classList.remove('hidden');
    };

    const saveProfileChanges = async (e) => {
        e.preventDefault();
        const user = auth.currentUser;
        if (!user) return;

        const newUsername = modalUsernameInput.value.trim();
        const newPhotoURL = modalPhotoUrlInput.value.trim();

        if (!newUsername) {
            handleAuthError({ code: 'client/username-empty', message: 'Username tidak boleh kosong.' });
            return;
        }

        try {
            await updateProfile(user, {
                displayName: newUsername,
                photoURL: newPhotoURL
            });

            await update(ref(db, `users/${user.uid}`), {
                username: newUsername,
                displayName: newUsername,
                photoURL: newPhotoURL
            });

            profileImg.src = newPhotoURL || 'https://placehold.co/200x200/FFF9E0/000?text=?';
            profileUsername.textContent = newUsername;
            editProfileModal.classList.add('hidden');

        } catch (error) {
            handleAuthError(error);
        }
    };

    const closeEditModal = (e) => {
        e.preventDefault();
        editProfileModal.classList.add('hidden');
    };
    
    const handleTabSwitch = (e) => {
        const clickedTab = e.target.closest('.profile-tab-btn');
        if (!clickedTab) return;
        
        const targetTab = clickedTab.dataset.tab;
        
        tabsContainer.querySelectorAll('.profile-tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        clickedTab.classList.add('active');
        
        tabPanelsContainer.querySelectorAll('.profile-tab-panel').forEach(panel => {
            panel.classList.remove('active');
        });
        
        document.getElementById(`tab-panel-${targetTab}`).classList.add('active');
    };

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('google-login-btn').addEventListener('click', googleLogin);
        document.getElementById('github-login-btn').addEventListener('click', githubLogin);

        document.getElementById('email-login-btn').addEventListener('click', loginEmail);
        document.getElementById('register-btn').addEventListener('click', registerEmail);

        document.getElementById('logout-btn').addEventListener('click', logout);

        document.getElementById('edit-profile-btn').addEventListener('click', openEditModal);
        document.getElementById('save-profile-btn').addEventListener('click', saveProfileChanges);
        document.getElementById('cancel-edit-btn').addEventListener('click', closeEditModal);
        
        tabsContainer.addEventListener('click', handleTabSwitch);
    });
  </script>

</body>
</html>