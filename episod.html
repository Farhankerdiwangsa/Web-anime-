<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nonton Episode | TongDev Stream</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bangers:wght@400&family=Inter:wght@400;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <script src="https://cdn.tailwindcss.com"></script>

  <style type="text/tailwindcss">
    @layer base {
      body {
        @apply bg-panel text-textblack font-inter antialiased overflow-x-hidden;
        background-color: #FFF9E0; 
        color: #000000; 
      }
      .horizontal-scrollbar::-webkit-scrollbar {
        height: 8px;
      }
      .horizontal-scrollbar::-webkit-scrollbar-track {
        background: #000000;
        border-radius: 4px;
        @apply comic-border border-2;
      }
      .horizontal-scrollbar::-webkit-scrollbar-thumb {
        background: #FFC300; 
        border-radius: 4px;
        @apply comic-border border-2;
      }
      .horizontal-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #FFD75C;
      }

      #video-loader-overlay {
        @apply absolute inset-0 bg-black/50 backdrop-blur-sm z-10 flex items-center justify-center transition-opacity duration-300 opacity-0 pointer-events-none;
      }
      #video-loader-overlay.active {
        @apply opacity-100 pointer-events-auto;
      }
      .video-spinner {
        @apply w-12 h-12 border-4 border-panel border-t-mustard rounded-full animate-spin;
      }

      .toast-notification {
        @apply fixed bottom-4 right-4 bg-mustard text-textblack font-bold px-6 py-3 rounded-lg comic-border comic-shadow z-[99] translate-y-20 opacity-0 transition-all duration-300 ease-out;
      }
      .toast-notification.show {
        @apply translate-y-0 opacity-100;
      }
    }
    
    @keyframes dot-bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-12px); }
    }
    .loader-dot {
      width: 12px;
      height: 12px;
      background-color: #FFC300; 
      border-radius: 50%;
      @apply comic-border border-2;
      animation: dot-bounce 1.4s infinite ease-in-out;
    }
    .loader-dot:nth-child(2) { animation-delay: -0.16s; }
    .loader-dot:nth-child(3) { animation-delay: -0.32s; }

    @layer components {
      .comic-title-stroke {
        font-family: 'Bangers', cursive;
        letter-spacing: 1px;
        color: #FFD75C !important;
        text-shadow:
          2px 2px 0 #000, -2px -2px 0 #000, 2px -2px 0 #000,
          -2px 2px 0 #000, 2px 0 0 #000, -2px 0 0 #000,
          0 2px 0 #000, 0 -2px 0 #000, 1px 1px 2px rgba(0, 0, 0, 0.6);
      }
      .comic-border {
        @apply border-4 border-textblack;
      }
      .comic-shadow {
        box-shadow: 6px 6px 0px #000000;
      }
      
      .player-action-button {
        @apply flex items-center justify-center gap-2 bg-panel font-semibold text-base px-4 py-2 rounded-lg text-textblack;
        @apply comic-border comic-shadow;
        @apply transition-all duration-200 hover:scale-[1.05] active:scale-95 active:shadow-none active:translate-x-[2px] active:translate-y-[2px] disabled:opacity-70 disabled:grayscale;
      }
      .player-action-button.active {
        @apply !bg-mustard !text-black !font-bold !border-textblack;
        box-shadow: 2px 2px 0px #000000 !important;
      }

      .episode-nav-button {
        @apply flex-shrink-0 w-12 h-12 sm:w-14 sm:h-14 flex items-center justify-center bg-panel font-bangers text-2xl sm:text-3xl rounded-lg text-textblack;
        @apply comic-border comic-shadow;
        @apply transition-all duration-200 hover:scale-[1.05] active:scale-95 active:shadow-none active:translate-x-[2px] active:translate-y-[2px];
      }
      .episode-nav-button.active {
        @apply !bg-mustard !text-black !font-bold !border-textblack;
        box-shadow: 2px 2px 0px #000000 !important;
      }

      .comment-filter-button {
        @apply bg-panel font-semibold text-base px-5 py-2 rounded-lg text-textblack;
        @apply comic-border comic-shadow;
        @apply transition-all duration-200 hover:scale-[1.05] active:scale-95 active:shadow-none active:translate-x-[2px] active:translate-y-[2px];
      }
      .comment-filter-button.active {
        @apply !bg-mustard !text-black !font-bold !border-textblack;
        box-shadow: 2px 2px 0px #000000 !important;
      }

      .comic-input {
        @apply w-full p-3 font-inter text-lg text-textblack bg-white comic-border rounded-md focus:outline-none focus:ring-4 focus:ring-mustard;
      }

      .comic-button {
        @apply bg-mustard font-bangers text-2xl px-6 py-2 comic-border rounded-md comic-shadow text-textblack comic-title-stroke tracking-wider transition-all duration-200 hover:scale-105 active:scale-95 active:shadow-none active:translate-x-1 active:translate-y-1;
      }
    }
    
    @layer utilities {
      .tap-highlight-transparent {
        -webkit-tap-highlight-color: transparent;
      }
    }
  </style>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            mustard: '#FFC300',
            panel: '#FFF9E0', 
            textblack: '#000000', 
          },
          fontFamily: {
            bangers: ['Bangers', 'cursive'],
            inter: ['Inter', 'sans-serif'],
          }
        }
      }
    }
  </script>
</head>
<body class="bg-panel text-textblack font-inter">

  <div id="page-loader" class="fixed inset-0 bg-panel z-[100] flex flex-col items-center justify-center space-y-4 transition-opacity duration-500 ease-in-out">
    <div class="flex space-x-2">
      <div class="loader-dot"></div>
      <div class="loader-dot"></div>
      <div class="loader-dot"></div>
    </div>
    <p class="font-bangers text-2xl text-textblack tracking-wider">Memuat Halaman...</p>
  </div>

  <div id="floating-login-panel" class="fixed inset-0 bg-black/60 backdrop-blur-md z-50 flex justify-center items-center p-4 opacity-0 transition-opacity duration-500 ease-in-out pointer-events-none">
    <div class="bg-panel comic-border comic-shadow rounded-lg p-8 sm:p-12 text-center max-w-md w-full relative">
      <h2 class="comic-title-stroke text-5xl sm:text-6xl text-mustard mt-4">
        Login Dulu, Wibu ðŸ˜Ž
      </h2>
      <p class="font-inter text-xl sm:text-2xl mt-6 text-textblack">
        Kamu harus login untuk nonton, like, dan komentar!
      </p>
      <a href="auth.html" class="comic-button mt-10 inline-block !text-3xl">
        Login Sekarang
      </a>
      <button id="close-login-panel-btn" class="absolute top-4 right-4 bg-panel hover:bg-white text-textblack rounded-md w-10 h-10 flex items-center justify-center transition-all comic-border comic-shadow hover:scale-105 active:scale-95" aria-label="Tutup">
        <i class="fa-solid fa-times text-xl"></i>
      </button>
    </div>
  </div>
  
  <div id="error-state" class="fixed inset-0 bg-panel z-[90] flex-col items-center justify-center space-y-4 p-4 text-center hidden">
    <h2 class="comic-title-stroke text-6xl text-mustard">Oops!</h2>
    <p id="error-message-text" class="font-inter text-xl text-textblack max-w-lg">Terjadi kesalahan. Coba muat ulang halaman.</p>
    <button id="retry-button" class="comic-button mt-6 !text-3xl">
      Coba Lagi
    </button>
  </div>

  <header id="navbar" class="bg-mustard comic-border border-b-8 p-3 sm:p-4 md:p-6 shadow-lg sticky top-0 z-40 flex items-center justify-center relative">
    <button onclick="history.back()" class="absolute left-4 top-1/2 -translate-y-1/2 bg-panel hover:bg-white text-textblack rounded-md w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center transition-all comic-border comic-shadow hover:scale-105 active:scale-95" aria-label="Kembali">
      <i class="fa-solid fa-arrow-left sm:text-xl"></i>
    </button>
    <a href="index.html" class="comic-title-stroke text-4xl sm:text-5xl text-mustard text-center tap-highlight-transparent">
      TongDev | Stream
    </a>
  </header>

  <main id="main-content" class="max-w-6xl mx-auto p-3 sm:p-4 pb-24">

    <section class="mb-4">
      <div id="player-wrapper" class="w-full aspect-[16/9] bg-black rounded-lg comic-border comic-shadow overflow-hidden relative">
        <img src="https://placehold.co/1600x900/000/FFF?text=Memuat+Video..." class="w-full h-full object-cover" alt="Video Placeholder">
        
        <div id="video-loader-overlay">
          <div class="video-spinner"></div>
        </div>
      </div>
      
      <div class="flex justify-end mt-3">
        <div id="quality-dropdown" class="relative hidden"> 
          <button id="quality-btn" class="player-action-button">
            <i class="fa-solid fa-sliders"></i>
            <span id="quality-btn-label">...</span>
            <i class="fa-solid fa-chevron-down text-xs ml-1"></i>
          </button>
          <div id="quality-menu" class="absolute bottom-full mb-2 right-0 bg-panel comic-border comic-shadow rounded-lg overflow-hidden w-32 z-10 hidden flex-col-reverse">
          </div>
        </div>
      </div>
    </section>

    <section id="action-bar-skeleton" class="mt-4 flex justify-center gap-3 sm:gap-4 animate-pulse">
      <div class="w-28 h-12 bg-gray-300 rounded-lg comic-border"></div>
      <div class="w-28 h-12 bg-gray-300 rounded-lg comic-border"></div>
      <div class="w-28 h-12 bg-mustard/50 rounded-lg comic-border"></div>
    </section>
    
    <section id="action-bar-content" class="mt-4 flex justify-center gap-3 sm:gap-4 hidden">
      <button id="like-btn" class="player-action-button">
        <i class="fa-solid fa-thumbs-up"></i>
        <span id="like-count">0</span>
      </button>
      <button id="dislike-btn" class="player-action-button">
        <i class="fa-solid fa-thumbs-down"></i>
        <span id="dislike-count">0</span>
      </button>
      <a id="download-btn" href="#" class="player-action-button !bg-mustard !text-black" download>
        <i class="fa-solid fa-download"></i>
        <span>Unduh</span>
      </a>
    </section>

    <section id="episode-nav-section" class="mt-6">
      <h2 class="text-3xl font-bangers text-textblack mb-4 tracking-wide" id="episode-title">
        Memuat Episode...
      </h2>
      
      <div id="episode-nav-skeleton" class="flex gap-2 sm:gap-3 overflow-x-auto pb-3 animate-pulse">
        <div class="w-12 h-12 sm:w-14 sm:h-14 flex-shrink-0 bg-gray-300 rounded-lg comic-border"></div>
        <div class="w-12 h-12 sm:w-14 sm:h-14 flex-shrink-0 bg-gray-300 rounded-lg comic-border"></div>
        <div class="w-12 h-12 sm:w-14 sm:h-14 flex-shrink-0 bg-mustard/50 rounded-lg comic-border"></div>
        <div class="w-12 h-12 sm:w-14 sm:h-14 flex-shrink-0 bg-gray-300 rounded-lg comic-border"></div>
        <div class="w-12 h-12 sm:w-14 sm:h-14 flex-shrink-0 bg-gray-300 rounded-lg comic-border"></div>
      </div>

      <div id="episode-list" class="flex gap-2 sm:gap-3 overflow-x-auto pb-3 horizontal-scrollbar hidden">
      </div>
    </section>

    <section id="comment-section" class="mt-6 hidden">
      <h2 id="comment-count-title" class="text-3xl font-bangers text-textblack mb-4 tracking-wide">
        Komentar (0)
      </h2>
      
      <div class="flex gap-2 sm:gap-4 mb-4">
        <button id="sort-populer-btn" class="comment-filter-button">
          <i class="fa-solid fa-fire"></i> Populer
        </button>
        <button id="sort-terbaru-btn" class="comment-filter-button active">
          <i class="fa-solid fa-clock"></i> Terbaru
        </button>
      </div>

      <form id="comment-form" class="mb-6">
        <div class="flex items-center gap-3">
          <img id="comment-user-avatar" src="https://placehold.co/40x40/FFF9E0/000?text=?" alt="Avatar" class="w-10 h-10 rounded-full comic-border border-2 object-cover flex-shrink-0" onerror="this.src='https://placehold.co/40x40/FFF9E0/000?text=?'">
          <input id="comment-input" type="text" class="comic-input flex-1" placeholder="Login untuk komentar..." disabled>
          <button id="comment-submit-btn" type="submit" class="w-12 h-12 flex-shrink-0 flex items-center justify-center bg-mustard rounded-lg comic-border comic-shadow transition-all hover:scale-105 active:scale-95" aria-label="Kirim Komentar" disabled>
            <i class="fa-solid fa-paper-plane text-textblack text-xl"></i>
          </button>
        </div>
      </form>
      
      <div id="comment-skeleton" class="space-y-4">
        <div class="flex gap-3 animate-pulse">
          <div class="w-10 h-10 rounded-full bg-gray-300 comic-border border-2 flex-shrink-0"></div>
          <div class="flex-1 space-y-2">
            <div class="w-1/3 h-4 bg-gray-300 rounded"></div>
            <div class="w-2/3 h-4 bg-gray-300 rounded"></div>
          </div>
        </div>
        <div class="flex gap-3 animate-pulse">
          <div class="w-10 h-10 rounded-full bg-gray-300 comic-border border-2 flex-shrink-0"></div>
          <div class="flex-1 space-y-2">
            <div class="w-1/4 h-4 bg-gray-300 rounded"></div>
            <div class="w-3/4 h-4 bg-gray-300 rounded"></div>
          </div>
        </div>
      </div>
      
      <div id="comment-list" class="space-y-4">
      </div>
      
      <p id="no-comments-msg" class="text-center text-gray-600 font-semibold text-lg py-6 hidden">
        Belum ada komentar. Jadilah yang pertama!
      </p>

    </section>

  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { 
      getAuth, 
      onAuthStateChanged,
      setPersistence,
      browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
    import { 
      getDatabase, 
      ref, 
      onValue, 
      off, 
      get, 
      set, 
      remove, 
      push, 
      serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDDwVSn_7EYluIaFjyqZcg2aFjpEiNbEiw",
      authDomain: "web-anime-f8aab.firebaseapp.com",
      databaseURL: "https://web-anime-f8aab-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "web-anime-f8aab",
      storageBucket: "web-anime-f8aab.appspot.com",
      messagingSenderId: "745149903589",
      appId: "1:745149903589:web:212faa7ba522644ccf1a0c",
      measurementId: "G-B81VMWHBN9"
    };

    const BASE_API = "https://backend.syaii.my.id";
    const ENDPOINT_ANIME = BASE_API + "/api/anime?url=";
    const ENDPOINT_EPISODE = BASE_API + "/api/episode?url=";
    const THROTTLE_DELAY = 5000;
    const DEFAULT_AVATAR = "https://placehold.co/40x40/FFF9E0/000?text=?";

    const state = {
      app: null,
      auth: null,
      db: null,
      currentUser: null,
      currentEpisodeUrl: null,
      currentAnimeUrl: null,
      currentEpisodeId: null,
      currentAnimeId: null,
      videoSources: [],
      currentQuality: null,
      player: null,
      lastProgressSave: 0,
      globalListeners: [],
      userListeners: [],
      commentSortBy: 'terbaru',
      commentsDataCache: null
    };

    const dom = {};

    function initDOMRefs() {
      const ids = [
        'page-loader', 'floating-login-panel', 'close-login-panel-btn', 'main-content',
        'error-state', 'error-message-text', 'retry-button', 'player-wrapper',
        'video-loader-overlay', 'action-bar-skeleton', 'action-bar-content',
        'like-btn', 'like-count', 'dislike-btn', 'dislike-count', 'quality-dropdown',
        'quality-btn', 'quality-btn-label', 'quality-menu', 'download-btn',
        'episode-nav-section', 'episode-list', 'episode-nav-skeleton', 'episode-title',
        'comment-section', 'comment-form', 'comment-input', 'comment-submit-btn',
        'comment-user-avatar', 'comment-list', 'no-comments-msg',
        'comment-skeleton', 'comment-count-title', 'sort-populer-btn', 'sort-terbaru-btn'
      ];
      
      let missing = [];
      ids.forEach(id => {
        const el = document.getElementById(id);
        if (!el) missing.push(id);
        dom[id.replace(/-(\w)/g, (m, c) => c.toUpperCase())] = el;
      });
      
      if (missing.length > 0) {
        console.error("Missing critical DOM elements:", missing);
        throw new Error("Struktur HTML tidak valid. Element hilang: " + missing.join(', '));
      }
      
      dom.headerTitleLink = document.querySelector('header a.comic-title-stroke'); 
    }

    async function main() {
      try {
        initDOMRefs();
      } catch (error) {
         console.error("DOM Init Error:", error);
         showError(error.message);
         return;
      }
      
      showLoader(true);

      try {
        await initFirebase();
      } catch (error) {
        console.error("Firebase Init Error:", error);
        showError("Gagal menginisialisasi aplikasi. Coba muat ulang.");
        return;
      }

      const episodeUrl = getUrlParam('url');
      if (!episodeUrl) {
        showError("URL episode tidak ditemukan. Pastikan URL Anda benar.");
        return;
      }

      state.currentEpisodeUrl = episodeUrl;
      state.currentAnimeUrl = getAnimeUrlFromEpisodeUrl(episodeUrl);
      
      state.currentEpisodeId = generateIdFromUrl(episodeUrl); 
      state.currentAnimeId = generateIdFromUrl(state.currentAnimeUrl); 

      if (!state.currentEpisodeId || !state.currentAnimeId) {
        showError("URL episode atau anime tidak valid.");
        return;
      }

      setupDOMListeners();
      attachGlobalListeners();

      await loadAllData(state.currentEpisodeUrl, state.currentAnimeUrl);
    }

    async function loadAllData(episodeUrl, animeUrl) {
      showLoader(true);
      toggleMainContent(false);

      try {
        const [episodeResult, animeResult] = await Promise.allSettled([
          fetchWithRetry(ENDPOINT_EPISODE + encodeURIComponent(episodeUrl)),
          fetchWithRetry(ENDPOINT_ANIME + encodeURIComponent(animeUrl))
        ]);

        if (episodeResult.status === 'rejected') {
          throw new Error(`Gagal memuat data episode: ${episodeResult.reason.message}`);
        }

        const episodeData = episodeResult.value;
        
        if (!episodeData.sources || episodeData.sources.length === 0) {
          throw new Error("Tidak ditemukan sumber video untuk episode ini.");
        }
        
        state.videoSources = normalizeSources(episodeData.sources);

        initializePlayer(episodeData);
        
        renderQualityButtons(state.videoSources);
        dom.qualityDropdown.classList.remove('hidden');

        if (animeResult.status === 'fulfilled') {
          const animeData = animeResult.value;
          const episodes = animeData.episodesList || animeData.episodes || [];
          const currentEp = episodes.find(ep => ep.url === episodeUrl);
          
          const animeTitle = animeData.title || "Anime";
          const episodeTitle = currentEp?.title || episodeData.title || "Episode";

          document.title = `${episodeTitle} | ${animeTitle} | TongDev Stream`;
          dom.episodeTitle.textContent = episodeTitle;
          
          renderEpisodeNavigation(episodes, episodeUrl);
        } else {
          console.warn("Gagal memuat data list anime:", animeResult.reason.message);
          dom.episodeTitle.textContent = episodeData.title || "Episode";
          dom.episodeList.innerHTML = `<p class="text-gray-500 pl-2">Gagal memuat episode lain.</p>`;
        }
        
        toggleMainContent(true);
        showLoader(false);

      } catch (error) {
        console.error("LoadAllData Error:", error);
        showError(error.message || "Terjadi kesalahan saat memuat data.");
      }
    }

    async function initFirebase() {
      try {
        state.app = initializeApp(firebaseConfig);
        state.auth = getAuth(state.app);
        
        await setPersistence(state.auth, browserLocalPersistence);
        
        state.db = getDatabase(state.app);
        
        await setupAuthListener();

      } catch (error) {
        console.error("Firebase Init Error:", error);
        throw new Error("Gagal menginisialisasi layanan data.");
      }
    }

    function setupAuthListener() {
      return new Promise((resolve) => {
        onAuthStateChanged(state.auth, (user) => {
          if (user && !user.isAnonymous) {
            state.currentUser = user;
            hideLoginPanel();
            updateUIForLoggedInUser();
            attachUserSpecificListeners();
          } else {
            state.currentUser = null;
            updateUIForLoggedOutUser();
            cleanupUserListeners();
          }
          resolve(user);
        });
      });
    }

    function initializePlayer(episodeData) {
      dom.playerWrapper.innerHTML = '';

      state.player = document.createElement('video');
      state.player.id = 'player';
      state.player.className = 'w-full h-full object-contain bg-black'; 
      state.player.playsInline = true;
      state.player.crossOrigin = 'anonymous';
      state.player.preload = 'metadata';
      state.player.controls = true;
      state.player.controlsList = 'nodownload'; 
      
      state.player.poster = episodeData.videoElement?.dataPoster || 
        'https://placehold.co/1600x900/000/FFF?text=Memuat+Video...';

      const defaultSource = chooseDefaultSource(state.videoSources);
      if (!defaultSource) {
        throw new Error("Tidak ada sumber video yang valid.");
      }
      
      state.player.src = defaultSource.src;
      state.currentQuality = defaultSource.size;
      updateDownloadButton(defaultSource.src);

      dom.playerWrapper.appendChild(state.player);
      dom.playerWrapper.appendChild(dom.videoLoaderOverlay);

      attachPlayerEvents();
    }

    function attachPlayerEvents() {
      if (!state.player) return;

      state.player.addEventListener('play', handlePlayAttempt);
      state.player.addEventListener('waiting', () => showVideoBufferOverlay(true));
      state.player.addEventListener('playing', () => showVideoBufferOverlay(false));
      state.player.addEventListener('canplay', () => showVideoBufferOverlay(false));
      state.player.addEventListener('timeupdate', saveProgressThrottled);
      state.player.addEventListener('error', handlePlayerError);
      state.player.addEventListener('stalled', handleVideoStall);
      
      state.player.addEventListener('loadedmetadata', () => {
        showLoader(false);
        restoreProgressIfAny();
      });
    }
    
    function handlePlayAttempt() {
      if (!state.currentUser && state.player) {
        state.player.pause();
        showLoginPanel();
      }
    }

    function handlePlayerError() {
      console.error("Video Player Error:", state.player.error);
      showVideoBufferOverlay(false);
      showToast("Gagal memuat video. Mencoba kualitas lain...");
      
      const nextSource = findNextLowerQuality();
      if (nextSource) {
        switchQuality(nextSource);
      } else {
        showError("Semua sumber video gagal dimuat.");
      }
    }

    function handleVideoStall() {
      showVideoBufferOverlay(true);
      showToast("Koneksi lambat, mencoba beralih ke kualitas lebih rendah...");
      
      const nextSource = findNextLowerQuality();
      if (nextSource) {
        switchQuality(nextSource);
      } else {
        showToast("Kualitas terendah sedang digunakan.");
      }
    }

    function chooseDefaultSource(sources) {
      if (!sources || sources.length === 0) return null;
      
      const sortedSources = [...sources].sort((a, b) => b.numericSize - a.numericSize);
      
      const connection = navigator.connection;
      let defaultSource = sortedSources[0];

      if (connection?.effectiveType) {
        if (connection.effectiveType.includes('2g') || connection.effectiveType.includes('slow-2g')) {
          defaultSource = sortedSources.find(s => s.numericSize <= 360) || sortedSources[sortedSources.length - 1];
        } else if (connection.effectiveType.includes('3g')) {
          defaultSource = sortedSources.find(s => s.numericSize <= 480) || sortedSources[sortedSources.length - 1];
        } else if (connection.effectiveType.includes('4g')) {
          defaultSource = sortedSources.find(s => s.numericSize <= 720) || sortedSources[0];
        }
      }
      
      return defaultSource;
    }

    function renderQualityButtons(sources) {
      dom.qualityMenu.innerHTML = '';
      
      const sortedSources = [...sources].sort((a, b) => a.numericSize - b.numericSize);
      
      sortedSources.forEach(source => {
        const btn = document.createElement('button');
        btn.className = 'w-full text-left px-4 py-2 font-semibold hover:bg-mustard';
        btn.textContent = `${source.size}p`;
        btn.dataset.src = source.src;
        btn.dataset.size = source.size;
        
        if (source.size === state.currentQuality) {
          btn.classList.add('bg-mustard', 'font-bold');
        } else {
          btn.classList.add('bg-panel');
        }

        btn.addEventListener('click', () => switchQuality(source));
        dom.qualityMenu.appendChild(btn);
      });

      dom.qualityBtnLabel.textContent = `${state.currentQuality}p`;
    }

    async function switchQuality(newSource) {
      if (!state.player || newSource.size === state.currentQuality) {
        dom.qualityMenu.classList.add('hidden');
        return;
      }

      const currentTime = state.player.currentTime;
      const wasPaused = state.player.paused;

      showVideoBufferOverlay(true);
      showToast(`Beralih ke ${newSource.size}p...`);

      state.player.src = newSource.src;
      state.player.load();

      try {
        await state.player.play();
        
        state.player.currentTime = currentTime;
        
        if (wasPaused) {
          state.player.pause();
        }
      } catch (error) {
        console.warn("Switch quality play() interrupted:", error);
      }

      state.currentQuality = newSource.size;
      updateDownloadButton(newSource.src);
      renderQualityButtons(state.videoSources);
      dom.qualityMenu.classList.add('hidden');
    }

    function findNextLowerQuality() {
      const sortedSources = [...state.videoSources].sort((a, b) => b.numericSize - a.numericSize);
      const currentIdx = sortedSources.findIndex(s => s.size === state.currentQuality);
      
      if (currentIdx !== -1 && currentIdx < sortedSources.length - 1) {
        return sortedSources[currentIdx + 1];
      }
      return null;
    }

    function renderEpisodeNavigation(episodes, currentEpisodeUrl) {
      dom.episodeList.innerHTML = ''; 
      
      if (!episodes || episodes.length === 0) {
        dom.episodeList.innerHTML = `<p class="text-gray-500 pl-2">Tidak ada episode lain.</p>`;
        return;
      }

      let activeEpisodeElement = null;

      episodes.forEach((ep) => {
        const a = document.createElement('a');
        a.href = `episod.html?url=${encodeURIComponent(ep.url)}`;
        a.className = 'episode-nav-button';
        const epNumber = ep.title.match(/(\d+)/);
        a.textContent = epNumber ? epNumber[1] : '?';
        a.title = ep.title; 

        if (ep.url === currentEpisodeUrl) {
          a.classList.add('active');
          a.setAttribute('aria-current', 'page');
          activeEpisodeElement = a;
        }

        dom.episodeList.appendChild(a);
      });

      if (activeEpisodeElement) {
        setTimeout(() => {
          activeEpisodeElement.scrollIntoView({
            behavior: 'smooth',
            block: 'nearest',
            inline: 'center'
          });
        }, 300); 
      }
    }

    function attachGlobalListeners() {
      const episodeKey = state.currentEpisodeId;
      if (!episodeKey) return;

      try {
        const likesRef = ref(state.db, `episodes/${episodeKey}/likes`);
        const likesListener = onValue(likesRef, (snap) => {
          const count = snap.exists() ? Object.keys(snap.val()).length : 0;
          dom.likeCount.textContent = formatCount(count);
        });
        state.globalListeners.push({ ref: likesRef, listener: likesListener, type: 'value' });

        const dislikesRef = ref(state.db, `episodes/${episodeKey}/dislikes`);
        const dislikesListener = onValue(dislikesRef, (snap) => {
          const count = snap.exists() ? Object.keys(snap.val()).length : 0;
          dom.dislikeCount.textContent = formatCount(count);
        });
        state.globalListeners.push({ ref: dislikesRef, listener: dislikesListener, type: 'value' });

        const commentsRef = ref(state.db, `episodes/${episodeKey}/comments`);
        const commentsListener = onValue(commentsRef, (snap) => {
          state.commentsDataCache = snap.val();
          renderComments();
          dom.commentSection.classList.remove('hidden');
        }, (error) => {
          console.error("Error fetching comments:", error);
          dom.commentList.innerHTML = `<p class="text-red-500">Gagal memuat komentar.</p>`;
          dom.commentSection.classList.remove('hidden');
        });
        state.globalListeners.push({ ref: commentsRef, listener: commentsListener, type: 'value' });
      } catch (error) {
        console.error("Error attaching global listeners:", error);
        showToast("Gagal terhubung ke data real-time.");
      }
    }

    function attachUserSpecificListeners() {
      const episodeKey = state.currentEpisodeId;
      const { currentUser } = state;
      if (!episodeKey || !currentUser) return;

      cleanupUserListeners();
      const uid = currentUser.uid;

      try {
        const userLikeRef = ref(state.db, `episodes/${episodeKey}/likes/${uid}`);
        const userLikeListener = onValue(userLikeRef, (snap) => {
          dom.likeBtn.classList.toggle('active', snap.exists());
        });
        state.userListeners.push({ ref: userLikeRef, listener: userLikeListener, type: 'value' });

        const userDislikeRef = ref(state.db, `episodes/${episodeKey}/dislikes/${uid}`);
        const userDislikeListener = onValue(userDislikeRef, (snap) => {
          dom.dislikeBtn.classList.toggle('active', snap.exists());
        });
        state.userListeners.push({ ref: userDislikeRef, listener: userDislikeListener, type: 'value' });
        
        restoreProgressIfAny();
      } catch (error)
      {
        console.error("Error attaching user-specific listeners:", error);
      }
    }

    function cleanupUserListeners() {
      state.userListeners.forEach(({ ref, listener, type }) => {
        try {
          off(ref, type, listener);
        } catch (e) {
          console.warn("Error detaching user listener:", e);
        }
      });
      state.userListeners = [];
      
      dom.likeBtn.classList.remove('active');
      dom.dislikeBtn.classList.remove('active');
    }
    
    function cleanupAllListeners() {
      [...state.globalListeners, ...state.userListeners].forEach(({ ref, listener, type }) => {
        try {
          off(ref, type, listener);
        } catch (e) {
          console.warn("Error detaching listener:", e);
        }
      });
      state.globalListeners = [];
      state.userListeners = [];
    }

    async function handleLikeDislike(isLike) {
      if (!state.currentUser) {
        showLoginPanel();
        return;
      }

      const episodeKey = state.currentEpisodeId;
      const { currentUser } = state;
      const uid = currentUser.uid;

      if (!episodeKey) {
          console.error("Episode key is missing, cannot like/dislike.");
          return;
      }
      
      const likeRef = ref(state.db, `episodes/${episodeKey}/likes/${uid}`);
      const dislikeRef = ref(state.db, `episodes/${episodeKey}/dislikes/${uid}`);
      
      const targetRef = isLike ? likeRef : dislikeRef;
      const otherRef = isLike ? dislikeRef : likeRef;
      const targetButton = isLike ? dom.likeBtn : dom.dislikeBtn;

      try {
        dom.likeBtn.disabled = true;
        dom.dislikeBtn.disabled = true;

        if (targetButton.classList.contains('active')) {
          await remove(targetRef);
        } else {
          await set(targetRef, true);
          await remove(otherRef); 
        }
      } catch (error) {
        console.error("Like/Dislike Error:", error);
        showToast("Gagal menyimpan vote.");
      } finally {
        dom.likeBtn.disabled = false;
        dom.dislikeBtn.disabled = false;
      }
    }

    async function handleCommentSubmit(e) {
      e.preventDefault();
      if (!state.currentUser) {
        showLoginPanel();
        return;
      }

      const text = dom.commentInput.value.trim();
      if (text.length === 0) {
        showToast("Komentar tidak boleh kosong.");
        return;
      }
      if (text.length > 1000) {
        showToast("Komentar terlalu panjang (maks 1000 karakter).");
        return;
      }
      
      const episodeKey = state.currentEpisodeId;
      const { currentUser } = state;

      if (!episodeKey) {
          console.error("Episode key is missing, cannot comment.");
          return;
      }

      const commentData = {
        userId: currentUser.uid,
        username: currentUser.displayName || "Wibu Anonim",
        photoURL: currentUser.photoURL || DEFAULT_AVATAR,
        text: text,
        timestamp: serverTimestamp(),
        likeCount: 0
      };

      try {
        dom.commentSubmitBtn.disabled = true;
        await push(ref(state.db, `episodes/${episodeKey}/comments`), commentData);
        dom.commentInput.value = '';
      } catch (error) {
        console.error("Comment Submit Error:", error);
        showToast("Gagal mengirim komentar.");
      } finally {
        dom.commentSubmitBtn.disabled = false;
      }
    }

    function renderComments() {
      dom.commentList.innerHTML = ''; 
      dom.commentSkeleton.classList.add('hidden');
      
      const commentsData = state.commentsDataCache;

      if (!commentsData || Object.keys(commentsData).length === 0) {
        dom.noCommentsMsg.classList.remove('hidden');
        dom.commentCountTitle.textContent = "Komentar (0)";
        return;
      }

      dom.noCommentsMsg.classList.add('hidden');
      
      const commentsArray = Object.keys(commentsData).map(key => ({
        id: key,
        ...commentsData[key]
      }));
      
      dom.commentCountTitle.textContent = `Komentar (${commentsArray.length})`;

      if (state.commentSortBy === 'populer') {
        commentsArray.sort((a, b) => (b.likeCount || 0) - (a.likeCount || 0));
      } else {
        commentsArray.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)); 
      }

      const fragment = document.createDocumentFragment();
      commentsArray.forEach(comment => {
        const div = document.createElement('div');
        div.className = 'flex gap-3';
        div.innerHTML = `
          <img src="${escapeHTML(comment.photoURL || DEFAULT_AVATAR)}" alt="Avatar" class="w-10 h-10 rounded-full comic-border border-2 object-cover flex-shrink-0" onerror="this.src='${DEFAULT_AVATAR}'">
          <div class="flex-1">
            <p class="font-bold text-textblack">${escapeHTML(comment.username)} 
              <span class="font-normal text-gray-600 text-sm ml-1">- ${formatTimeAgo(comment.timestamp)}</span>
            </p>
            <p class="font-inter text-textblack mt-1 break-words">${escapeHTML(comment.text)}</p>
          </div>
        `;
        fragment.appendChild(div);
      });
      
      dom.commentList.appendChild(fragment);
    }
    
    function saveProgressThrottled() {
      const now = Date.now();
      if (!state.currentUser || !state.player || state.player.readyState < 1 || (now - state.lastProgressSave < THROTTLE_DELAY)) {
        return;
      }

      state.lastProgressSave = now;
      
      const { currentAnimeId, currentEpisodeId, currentUser, player } = state;
      const currentTime = player.currentTime;
      const duration = player.duration;

      if (!duration || duration <= 0 || currentTime < 5 || currentTime > duration - 10) {
        return;
      }
      
      const animeId = currentAnimeId;
      const episodeId = currentEpisodeId; 
      
      if (!animeId || !episodeId) return;

      const progressData = {
        time: currentTime,
        duration: duration,
        timestamp: serverTimestamp()
      };
      
      try {
        set(ref(state.db, `users/${currentUser.uid}/progress/${animeId}/${episodeId}`), progressData)
          .catch(err => console.warn("Gagal simpan progres:", err.message));
      } catch (error) {
         console.warn("Gagal simpan progres (try/catch):", error.message);
      }
    }

    async function restoreProgressIfAny() {
      if (!state.currentUser || !state.player || state.player.readyState < 1) return; 

      const animeId = state.currentAnimeId;
      const episodeId = state.currentEpisodeId;
      const { currentUser } = state;
      
      if (!animeId || !episodeId) return;
      
      try {
        const progressRef = ref(state.db, `users/${currentUser.uid}/progress/${animeId}/${episodeId}`);
        const snapshot = await get(progressRef);

        if (snapshot.exists()) {
          const data = snapshot.val();
          const resumeTime = data.time;
          const duration = data.duration;

          if (resumeTime > 5 && resumeTime < duration - 10) {
            showToast(`Lanjut dari ${formatTime(resumeTime)}?`, () => {
              state.player.currentTime = resumeTime;
              if (state.player.paused) {
                state.player.play().catch(e => console.warn("Autoplay ditolak saat resume:", e));
              }
            }, 7000);
          }
        }
      } catch (error) {
        console.warn("Gagal mengambil progres:", error.message);
      }
    }

    function setupDOMListeners() {
      dom.retryButton.addEventListener('click', () => location.reload());

      dom.qualityBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        dom.qualityMenu.classList.toggle('hidden');
      });
      document.addEventListener('click', (e) => {
        if (!dom.qualityMenu.classList.contains('hidden') && !dom.qualityMenu.contains(e.target) && !dom.qualityBtn.contains(e.target)) {
          dom.qualityMenu.classList.add('hidden');
        }
      });

      dom.closeLoginPanelBtn.addEventListener('click', hideLoginPanel);

      dom.likeBtn.addEventListener('click', () => handleLikeDislike(true));
      dom.dislikeBtn.addEventListener('click', () => handleLikeDislike(false));

      dom.commentForm.addEventListener('submit', handleCommentSubmit);
      dom.commentInput.addEventListener('focus', () => {
        if (!state.currentUser) {
          dom.commentInput.blur();
          showLoginPanel();
        }
      });

      dom.sortPopulerBtn.addEventListener('click', () => setCommentSort('populer'));
      dom.sortTerbaruBtn.addEventListener('click', () => setCommentSort('terbaru'));

      window.addEventListener('beforeunload', cleanupAllListeners);
    }
    
    function setCommentSort(mode) {
      if (mode === state.commentSortBy) return;
      
      state.commentSortBy = mode;
      
      if (mode === 'populer') {
        dom.sortPopulerBtn.classList.add('active');
        dom.sortTerbaruBtn.classList.remove('active');
      } else {
        dom.sortTerbaruBtn.classList.add('active');
        dom.sortPopulerBtn.classList.remove('active');
      }
      
      renderComments();
    }

    function showLoader(isLoading) {
      if (isLoading) {
        dom.pageLoader.classList.remove('opacity-0', 'pointer-events-none');
      } else {
        setTimeout(() => {
          dom.pageLoader.classList.add('opacity-0', 'pointer-events-none');
        }, 500);
      }
    }
    
    function toggleMainContent(show) {
      if (show) {
        dom.actionBarSkeleton.classList.add('hidden');
        dom.episodeNavSkeleton.classList.add('hidden');
        
        dom.actionBarContent.classList.remove('hidden');
        dom.episodeList.classList.remove('hidden');
      } else {
        dom.actionBarSkeleton.classList.remove('hidden');
        dom.episodeNavSkeleton.classList.remove('hidden');
        
        dom.actionBarContent.classList.add('hidden');
        dom.episodeList.classList.add('hidden');
        dom.commentSection.classList.add('hidden');
      }
    }

    function showError(message) {
      showLoader(false);
      toggleMainContent(false); 
      dom.mainContent.classList.add('hidden'); 
      dom.errorMessageText.textContent = message;
      dom.errorState.classList.remove('hidden');
      dom.errorState.classList.add('flex'); 
    }

    function showLoginPanel() {
      dom.floatingLoginPanel.classList.remove('opacity-0', 'pointer-events-none');
      if (state.player && !state.player.paused) {
        state.player.pause();
      }
    }

    function hideLoginPanel() {
      dom.floatingLoginPanel.classList.add('opacity-0', 'pointer-events-none');
    }

    function showVideoBufferOverlay(isBuffering) {
      if(dom.videoLoaderOverlay) {
        dom.videoLoaderOverlay.classList.toggle('active', isBuffering);
      }
    }
    
    function showToast(message, onClickCallback = null, duration = 3000) {
      const oldToast = document.querySelector('.toast-notification');
      if (oldToast) oldToast.remove();
      
      const toast = document.createElement('div');
      toast.className = 'toast-notification';
      toast.textContent = message;
      
      if (onClickCallback) {
        toast.classList.add('cursor-pointer');
        toast.addEventListener('click', () => {
          onClickCallback();
          toast.remove();
        }, { once: true });
      }
      
      document.body.appendChild(toast);
      
      setTimeout(() => toast.classList.add('show'), 100);
      
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          if (document.body.contains(toast)) {
             document.body.removeChild(toast);
          }
        }, 300);
      }, duration);
    }

    function updateUIForLoggedInUser() {
      const user = state.currentUser;
      dom.commentUserAvatar.src = user.photoURL || DEFAULT_AVATAR;
      dom.commentInput.placeholder = `Komentar sebagai ${user.displayName || 'Wibu'}`;
      dom.commentInput.disabled = false;
      dom.commentSubmitBtn.disabled = false;
    }

    function updateUIForLoggedOutUser() {
      dom.commentUserAvatar.src = DEFAULT_AVATAR;
      dom.commentInput.placeholder = "Login untuk komentar...";
      dom.commentInput.disabled = true;
      dom.commentSubmitBtn.disabled = true;
    }
    
    function updateDownloadButton(src) {
      dom.downloadBtn.href = src;
    }

    function getUrlParam(name) {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
      } catch (e) {
        console.error("Error parsing URL params:", e);
        return null;
      }
    }

    async function fetchWithRetry(url, options = {}, retries = 3, delay = 500) {
      for (let i = 0; i < retries; i++) {
        try {
          const response = await fetch(url, { ...options, mode: 'cors' });
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return await response.json();
        } catch (error) {
          console.warn(`Fetch attempt ${i + 1} failed: ${error.message}. Retrying in ${delay}ms...`);
          if (i === retries - 1) throw error;
          await new Promise(res => setTimeout(res, delay));
          delay *= 2;
        }
      }
    }

    function getAnimeUrlFromEpisodeUrl(episodeUrl) {
      if (!episodeUrl) return '';
      const parts = episodeUrl.split('/');
      const episodeIndex = parts.lastIndexOf('episode');
      if (episodeIndex > 0) {
        return parts.slice(0, episodeIndex).join('/');
      }
      return episodeUrl.split('?')[0]; 
    }

    function generateIdFromUrl(url) {
      if (!url) return null;
      try {
        return encodeURIComponent(url).replace(/[%\.\/$#\[\]]/g, '-');
      } catch (e) {
        console.error("Error generating ID from URL:", e, url);
        return null;
      }
    }
    
    function normalizeSources(sources) {
      return sources.map(source => ({
        ...source,
        size: source.size || source.id || 'N/A',
        numericSize: parseInt(String(source.size || source.id).replace('p', '')) || 0
      }));
    }

    function formatCount(num) {
      if (num < 1000) return num.toString();
      if (num < 1000000) return (num / 1000).toFixed(1) + 'K';
      return (num / 1000000).toFixed(1) + 'M';
    }

    function formatTime(totalSeconds) {
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = Math.floor(totalSeconds % 60);
      return `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }

    function formatTimeAgo(timestamp) {
      if (typeof timestamp !== 'number' || timestamp <= 0) return "Baru saja";
      const now = Date.now();
      const seconds = Math.floor((now - timestamp) / 1000);

      if (seconds < 2) return "Baru saja";
      if (seconds < 60) return `${seconds} detik lalu`;
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes} menit lalu`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `${hours} jam lalu`;
      const days = Math.floor(hours / 24);
      if (days < 30) return `${days} hari lalu`;
      const months = Math.floor(days / 30);
      if (months < 12) return `${months} bulan lalu`;
      const years = Math.floor(days / 365);
      return `${years} tahun lalu`;
    }

    function escapeHTML(str) {
      if (typeof str !== 'string') return '';
      return str.replace(/[&<>"']/g, function(m) {
        return {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        }[m];
      });
    }

    document.addEventListener('DOMContentLoaded', main);

  </script>

</body>
</html>